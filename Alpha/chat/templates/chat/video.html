{%extends "home/index.html"%}
{%block content%}
{%load static%}

<!-- <div class="container">
    <div class="row py-2">
      <div class="col-sm">
        <video height="500" width="600" id="user"></video>
      </div>
      <div class="col-sm">
        <video height="300" id="remote"></video>
      </div>
    </div>
  </div> -->
  <style>

    .video-container{
    display: grid;
    grid-template-columns: repeat(3,1fr);
    background-color: black;
}
/* video{
     background-color: black; 
     border-radius: 20%;
} */
  </style>

  <div id = "video-container">
    <div><video id = "local-video" autoplay playsinline></video>
      <video id = "remote-video"></video>
      </div>
      
    <button id = "btn-toggle-audio">Audio Mute</button>
    <button id = "btn-toggle-video">Video Off </button>
 </div>

 <div>
  <button id="call" style="display: none" class="btn btn-outline-primary my-3 mx-3">Call</button>
 </div>
  <!-- <script type = "text/javascript" src = "{% static 'home/js/main.js' %}"></script> -->
 <script>
  const usr_vdo = document.getElementById('local-video');
  const remote_vdo = document.getElementById('remote-video');
  const call_btn = document.getElementById('call');

  var localstream = new MediaStream();
  let stream;
  let rtcpeerconnection;

  const created = '{{created}}';
  const room = "{{room}}";
  let isCreated;

  let iceServers = {
        iceServers: [
          { urls: "stun:stun.services.mozilla.com" },
          { urls: "stun:stun.l.google.com:19302" },
        ],
      };

  const constraints = {
    'video' : true,
    'audio' : true
  };

  var loc = window.location;
  console.log(loc);
  var wsStart = 'ws://'

  if (loc.protocol == 'https:'){
    wsStart = 'wss://'
  }

  var endPoint = wsStart + loc.host + loc.pathname;
  console.log(endPoint);

  webSocket = new WebSocket(endPoint);

  webSocket.onopen = () =>{
    console.log('opened');
    webSocket.send(JSON.stringify({
    command : "join_room",
    room : room,
    }));

    if (created == "created"){
    isCreated = true;
    console.log('created');
    navigator.mediaDevices.getUserMedia(constraints)
      .then((s) => {
          stream = s;
          usr_vdo.srcObject = s;
          usr_vdo.onloadeddata = () =>{
          usr_vdo.play();
          };
    });
    console.log(isCreated);
    }

    else{
    isCreated = false
    var userMedia = navigator.mediaDevices.getUserMedia(constraints)
    .then((s) =>{
      stream = s;
      usr_vdo.srcObject = s;
      usr_vdo.onloadeddata = () =>{
        usr_vdo.play();
      };
      webSocket.send(JSON.stringify({
      command: "join",
      room : room,
      }));
    });
    console.log(isCreated);
    }
  };
  
  webSocket.onmessage = (e) =>{
    const data = JSON.parse(e.data)
    console.log(data);
    if (data['command'] == 'join'){
      console.log(isCreated)
      if(isCreated){
        call_btn.style.display = "block"
      }
    } 
    else if (data['command'] == 'offer'){
      if (isCreated == false){
        createanswer(data['offer']);
      }
    }
    else if (data['command'] == 'answer'){
      if (isCreated){
        rtcpeerconnection.setRemoteDescription(data['answer']);
        console.log("answer set as remote");
      }
    }
    else if (data['command'] == 'candidate'){
      if (data['iscreated'] != isCreated){
        const IceCandidate = new RTCIceCandidate(data['candidate']);
        rtcpeerconnection.addIceCandidate(IceCandidate);
      }
    }  
  };

  call_btn.onclick = () =>{
    createoffer()
  }

  function createoffer() {
        console.log("offer started");
        rtcpeerconnection = new RTCPeerConnection(iceServers);
        rtcpeerconnection.onicecandidate = OnIceCandidateFunc;
        rtcpeerconnection.ontrack = OnTrackFunc;
        stream.getTracks().forEach((track) => {
          rtcpeerconnection.addTrack(track, stream);
        });
        rtcpeerconnection.createOffer().then((offer) => {
          rtcpeerconnection.setLocalDescription(offer);
          webSocket.send(
            JSON.stringify({
              command: "offer",
              offer: offer,
              room: room,
            })
          );
        });
      }
      function createanswer(offer) {
        console.log("answer started");
        rtcpeerconnection = new RTCPeerConnection(iceServers);
        rtcpeerconnection.onicecandidate = OnIceCandidateFunc;
        rtcpeerconnection.ontrack = OnTrackFunc;
        stream.getTracks().forEach((track) => {
          rtcpeerconnection.addTrack(track, stream);
        });
        rtcpeerconnection.setRemoteDescription(offer);
        rtcpeerconnection.createAnswer().then((answer) => {
          rtcpeerconnection.setLocalDescription(answer);
          webSocket.send(
            JSON.stringify({
              command: "answer",
              answer: answer,
              room: room,
            })
          );
        });
      }

  function OnIceCandidateFunc(e){
    if (e.candidate){
      webSocket.send(JSON.stringify({
        command:"candidate",
        candidate : e.candidate,
        iscreated : isCreated,
        room : room,
      }));
    }
  }

  function OnTrackFunc(e) {
    remote_vdo.srcObject = e.streams[0];
    remote_vdo.onloadedmetadata = () =>{
      remote_vdo.play();
    };
  }
</script>


  {%endblock content%}